package com.example.wearai

import android.app.RemoteInput
import android.content.Intent
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts
import androidx.core.splashscreen.SplashScreen.Companion.installSplashScreen
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.runtime.*
import androidx.compose.runtime.snapshots.SnapshotStateList
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.interaction.MutableInteractionSource
import androidx.compose.ui.interaction.collectIsPressedAsState
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.wear.compose.material.*
import androidx.wear.compose.foundation.lazy.ScalingLazyColumn
import androidx.wear.compose.foundation.lazy.items
import androidx.wear.compose.foundation.lazy.itemsIndexed
import androidx.wear.compose.foundation.lazy.rememberScalingLazyListState
import androidx.wear.compose.navigation.SwipeDismissableNavHost
import androidx.wear.compose.navigation.composable
import androidx.wear.compose.navigation.rememberSwipeDismissableNavController
import androidx.wear.input.RemoteInputIntentHelper
import com.example.wearai.presentation.theme.WearAITheme
import com.google.ai.client.generativeai.GenerativeModel
import kotlinx.coroutines.launch
import kotlinx.coroutines.delay

/**
 * WearAI Application
 * 
 * A Wear OS app that uses Gemini AI to generate responses to user questions.
 * Features include:
 * - Multiple model selection
 * - Dark/light theme toggle
 * - Text color customization
 * - Conversation history
 */

// Adding slight obfuscation to the API key
private val API_KEY = String(charArrayOf(
    'A', 'I', 'z', 'a', 'S', 'y', 'A', '2', 'U', 'w', 'm', 'Y', 'w', 'l', '1', 'u', 'o', 'o', 'y', 'X',
    'I', 'c', 'K', 'q', 's', 'f', '5', 'p', '8', 'W', '7', 'f', 'x', '0', '9', 't', 'r', 'h', 'U'
))

// Navigation routes
private object Routes {
    const val HOME = "home"
    const val CONVERSATION = "conversation"
}

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        installSplashScreen()
        super.onCreate(savedInstanceState)
        setContent {
            // Shared state for both screens
            val isDarkTheme = remember { mutableStateOf(true) }
            val isGreenText = remember { mutableStateOf(true) }
            val selectedModel = remember { mutableStateOf("gemini-2.0-flash") }
            val conversationHistory = remember { mutableStateListOf<Message>() }
            
            WearAIApp(
                isDarkTheme = isDarkTheme,
                isGreenText = isGreenText,
                selectedModel = selectedModel,
                conversationHistory = conversationHistory
            )
        }
    }
}

@Composable
fun ModelSelector(
    models: List<String>,
    selectedModel: String,
    onModelSelected: (String) -> Unit,
    textColor: Color,
    modifier: Modifier = Modifier
) {
    var expanded by remember { mutableStateOf(false) }
    
    if (expanded) {
        ScalingLazyColumn(
            modifier = modifier.fillMaxSize(),
        ) {
            items(models) { model ->
                CompactChip(
                    onClick = { 
                        onModelSelected(model)
                        expanded = false
                    },
                    label = {
                        Text(
                            text = model,
                            color = textColor,
                            fontSize = 12.sp
                        )
                    },
                    colors = ChipDefaults.chipColors(
                        backgroundColor = UIConstants.BUTTON_BACKGROUND
                    )
                )
            }
        }
    } else {
        CompactChip(
            onClick = { expanded = true },
            label = {
                Text(
                    text = "Model: ${selectedModel.substringAfter("gemini-")}",
                    color = textColor,
                    maxLines = 1,
                    fontSize = 12.sp
                )
            },
            icon = {
                Icon(
                    painter = painterResource(id = R.drawable.ic_model),
                    contentDescription = "Select model",
                    modifier = Modifier.size(UIConstants.ICON_SIZE)
                )
            },
            colors = ChipDefaults.chipColors(
                backgroundColor = UIConstants.BUTTON_BACKGROUND
            )
        )
    }
}

@Composable
fun MessageBubble(
    message: Message,
    isDarkTheme: Boolean,
    textColor: Color,
    modifier: Modifier = Modifier
) {
    val userGradient = Brush.linearGradient(
        colors = if (isDarkTheme) 
            listOf(UIConstants.USER_BUBBLE_COLOR, UIConstants.USER_BUBBLE_COLOR.copy(alpha = 0.7f)) 
        else 
            listOf(UIConstants.LIGHT_USER_BUBBLE_COLOR, UIConstants.LIGHT_USER_BUBBLE_COLOR.copy(alpha = 0.7f))
    )
    
    val aiGradient = Brush.linearGradient(
        colors = if (isDarkTheme) 
            listOf(UIConstants.AI_BUBBLE_COLOR, UIConstants.AI_BUBBLE_COLOR.copy(alpha = 0.7f)) 
        else 
            listOf(UIConstants.LIGHT_AI_BUBBLE_COLOR, UIConstants.LIGHT_AI_BUBBLE_COLOR.copy(alpha = 0.7f))
    )
    
    val bubbleAlignment = if (message.isUser) Alignment.CenterEnd else Alignment.CenterStart
    
    val bubbleShape = RoundedCornerShape(
        topStart = if (message.isUser) 8.dp else 2.dp,
        topEnd = if (message.isUser) 2.dp else 8.dp,
        bottomStart = 8.dp,
        bottomEnd = 8.dp
    )
    
    Box(
        modifier = modifier
            .fillMaxWidth()
            .padding(vertical = 4.dp),
        contentAlignment = bubbleAlignment
    ) {
        Box(
            modifier = Modifier
                .widthIn(max = 200.dp)
                .clip(bubbleShape)
                .background(if (message.isUser) userGradient else aiGradient)
                .padding(8.dp)
        ) {
            Text(
                text = message.text,
                color = textColor,
                fontSize = 12.sp
            )
        }
    }
}

@Composable
fun ConversationScreen(
    conversationHistory: List<Message>,
    isDarkTheme: Boolean,
    textColor: Color,
    onBackClick: () -> Unit,
    onReplyClick: () -> Unit,
    backgroundColor: Color
) {
    val listState = rememberScalingLazyListState()
    
    LaunchedEffect(conversationHistory.size) {
        if (conversationHistory.isNotEmpty()) {
            listState.animateScrollToItem(conversationHistory.size - 1)
        }
    }
    
    // Setup rotary scrolling for crown input
    Scaffold(
        timeText = {
            TimeText()
        },
        positionIndicator = {
            PositionIndicator(
                scalingLazyListState = listState
            )
        },
        vignette = {
            Vignette(vignettePosition = VignettePosition.TopAndBottom)
        }
    ) {
        Box(
            modifier = Modifier.fillMaxSize()
        ) {
            if (conversationHistory.isEmpty()) {
                Text(
                    text = "No messages yet",
                    color = textColor,
                    modifier = Modifier
                        .fillMaxSize()
                        .wrapContentSize(Alignment.Center)
                )
            } else {
                ScalingLazyColumn(
                    state = listState,
                    modifier = Modifier
                        .fillMaxSize()
                        .rotaryScrollable(listState)
                ) {
                    items(conversationHistory) { message ->
                        MessageBubble(
                            message = message,
                            isDarkTheme = isDarkTheme,
                            textColor = textColor
                        )
                    }
                }
            }
            
            // Bottom action buttons
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .align(Alignment.BottomCenter)
                    .padding(bottom = 8.dp),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                // Back button
                AnimatedActionIconButton(
                    onClick = onBackClick,
                    iconResourceId = R.drawable.ic_back,
                    contentDescription = "Go back"
                )
                
                // Reply button
                AnimatedActionIconButton(
                    onClick = onReplyClick,
                    iconResourceId = R.drawable.ic_reply,
                    contentDescription = "Reply"
                )
            }
        }
    }
}

@Composable
fun HomeScreen(
    question: MutableState<String>,
    isLoading: MutableState<Boolean>,
    isDarkTheme: MutableState<Boolean>,
    isGreenText: MutableState<Boolean>,
    selectedModel: String,
    models: List<String>,
    onModelSelected: (String) -> Unit,
    onSendQuestion: () -> Unit,
    onThemeToggle: () -> Unit,
    onTextColorToggle: () -> Unit,
    onViewConversation: () -> Unit,
    textColor: Color,
    backgroundColor: Color
) {
    val scrollState = rememberScrollState()
    
    Scaffold(
        timeText = {
            TimeText()
        },
        vignette = {
            Vignette(vignettePosition = VignettePosition.TopAndBottom)
        }
    ) {
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(8.dp)
                .verticalScroll(scrollState)
                .rotaryScrollable(scrollState)
            ,
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(8.dp)
        ) {
            // Model selector
            ModelSelector(
                models = models,
                selectedModel = selectedModel,
                onModelSelected = onModelSelected,
                textColor = textColor
            )
            
            // Action buttons row
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                // Theme toggle button
                AnimatedActionIconButton(
                    onClick = onThemeToggle,
                    iconResourceId = R.drawable.ic_theme_toggle,
                    contentDescription = "Toggle theme"
                )
                
                // Text color toggle button
                AnimatedActionIconButton(
                    onClick = onTextColorToggle,
                    iconResourceId = R.drawable.ic_color_toggle,
                    contentDescription = "Toggle text color"
                )
                
                // History button
                AnimatedActionIconButton(
                    onClick = onViewConversation,
                    iconResourceId = R.drawable.ic_history,
                    contentDescription = "View conversation history"
                )
            }
            
            // Text input
            TextInputCircle(
                placeholder = "Ask Gemini...",
                value = question.value,
                onValueChange = { question.value = it },
                textColor = textColor
            )
            
            // Send button
            if (question.value.isNotEmpty()) {
                AnimatedActionIconButton(
                    onClick = onSendQuestion,
                    iconResourceId = R.drawable.ic_send,
                    contentDescription = "Send message"
                )
            }
            
            // Loading indicator
            if (isLoading.value) {
                CircularProgressIndicator(
                    modifier = Modifier.size(24.dp),
                    color = textColor,
                    strokeWidth = 2.dp
                )
            }
        }
    }
}

@Composable
fun WearAIApp(
    isDarkTheme: MutableState<Boolean>,
    isGreenText: MutableState<Boolean>,
    selectedModel: MutableState<String>,
    conversationHistory: SnapshotStateList<Message>
) {
    WearAITheme(isDarkTheme = isDarkTheme.value) {
        val navController = rememberSwipeDismissableNavController()
        val scope = rememberCoroutineScope()
        val question = remember { mutableStateOf("") }
        val isLoading = remember { mutableStateOf(false) }
        val textColor = if (isGreenText.value) Color.Green else Color.White
        val backgroundColor = if (isDarkTheme.value) Color.Black else Color.White
        
        val models = listOf(
            "gemini-1.0-pro",
            "gemini-1.5-flash",
            "gemini-2.0-flash"
        )
        
        // AI model to use for generating responses
        val model = remember(selectedModel.value) {
            GenerativeModel(
                modelName = selectedModel.value,
                apiKey = this@MainActivity.getString(R.string.gemini_api_key)
            )
        }
        
        SwipeDismissableNavHost(
            navController = navController,
            startDestination = Routes.HOME
        ) {
            composable(Routes.HOME) {
                HomeScreen(
                    question = question,
                    isLoading = isLoading,
                    isDarkTheme = isDarkTheme,
                    isGreenText = isGreenText,
                    selectedModel = selectedModel.value,
                    models = models,
                    onModelSelected = { newModel ->
                        selectedModel.value = newModel
                    },
                    onSendQuestion = {
                        if (question.value.isNotBlank()) {
                            // Add user message to conversation
                            conversationHistory.add(Message(text = question.value, isUser = true))
                            
                            // AI response generation
                            isLoading.value = true
                            scope.launch {
                                try {
                                    val response = model.generateContent(question.value).text ?: "Sorry, I couldn't generate a response."
                                    // Add AI response to conversation
                                    conversationHistory.add(Message(text = response, isUser = false))
                                } catch (e: Exception) {
                                    // Handle error
                                    conversationHistory.add(Message(text = "Error: ${e.message}", isUser = false))
                                } finally {
                                    isLoading.value = false
                                    question.value = ""
                                }
                            }
                        }
                    },
                    onThemeToggle = {
                        isDarkTheme.value = !isDarkTheme.value
                    },
                    onTextColorToggle = {
                        isGreenText.value = !isGreenText.value
                    },
                    onViewConversation = {
                        navController.navigate(Routes.CONVERSATION)
                    },
                    textColor = textColor,
                    backgroundColor = backgroundColor
                )
            }
            
            composable(Routes.CONVERSATION) {
                ConversationScreen(
                    conversationHistory = conversationHistory.toList(),
                    isDarkTheme = isDarkTheme.value,
                    textColor = textColor,
                    onBackClick = {
                        navController.popBackStack()
                    },
                    onReplyClick = {
                        navController.popBackStack()
                    },
                    backgroundColor = backgroundColor
                )
            }
        }
    }
} 